<!doctype html>
<html lang="en">
<head>
    <title>Garden Species</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

    <style>
        body {
            padding-top: 5rem;
        }

        div.row > div {
            padding-bottom: 2rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link active" href="#">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link garden-link" data-target="species.html" href="#">Species</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#">Individuals</a>
            </li>
            <li class="nav-item">
                <a class="nav-link garden-link" data-target="garden.html" href="#">Garden</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">Property</a>
                <div id="svgMenu" class="dropdown-menu">
                </div>
            </li>
        </ul>
    </div>
</nav>

<div class="container">
    <div class="jumbotron">
        <h1 id="title"></h1>
        <p class="lead">Explore species catalog, list of plant individuals, and interactive garden map.</p>
        <p><a class="btn btn-lg btn-success garden-link" data-target="garden.html" href="#" role="button">View Garden</a></p>
    </div>
    <div class="row">
        <div class="col-md-4">
            <h2>Plant Individuals</h2>
            <ul id="listIndividuals" class="list-group">
            </ul>
            <a style="margin-top: 10px" class="btn btn-primary garden-link" data-target="species.html" href="#" role="button">View details</a>
        </div>
        <div id="divWeather" class="col-md-4">
            <h2>Weather</h2>
        </div>
        <div class="col-md-4">
            <h2>Sunlight Times</h2>
            <ul id="listSunlight" class="list-group">
            </ul>
        </div>
        <div class="col-md-4">
            <h2>Sun Position</h2>
            <ul id="listSunpos" class="list-group">
            </ul>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
<script src="js/conf.js"></script>
<script src="js/weather.js"></script>
<script src="js/fragment.js"></script>
<script src="js/range.js"></script>
<script src="js/angle.js"></script>
<script src="js/svg.js"></script>
<script src="js/fragment.js"></script>
<script>
    const dateFormat = {month: '2-digit', day: '2-digit', year: 'numeric'};
    const timeFormat = {hour: '2-digit', minute: '2-digit'};

    const fragment = new Fragment();

    let svgName = fragment.get("svg") || "cambridge";
    let svg = new Svg(`img/${svgName}.svg`);

    let listIndividuals = $("#listIndividuals");
    let listSunlight = $("#listSunlight");
    let listSunpos = $("#listSunpos");
    let title = $("#title");
    let gardenLinks = $(".garden-link");
    let svgMenu = $("#svgMenu");
    let divWeather = $("#divWeather");

    function formatDate(date) {
        return date.toLocaleDateString('en', dateFormat);
    }

    function formatTime(date) {
        return date.toLocaleTimeString('en', timeFormat);
    }

    function updateContent() {
        const date = new Date();
        const sunpos = SunCalc.getPosition(date, svg.latitude, svg.longitude);
        const sunlight = SunCalc.getTimes(date, svg.latitude, svg.longitude);
        const azimuth = GardenAngle.normalizeDegrees(90 - GardenAngle.toDegrees(3 * Math.PI / 2 - sunpos.azimuth)).toFixed(2);
        const altitude = GardenAngle.toDegrees(sunpos.altitude).toFixed(2);

        listIndividuals.find("li").remove();
        listIndividuals.append(`<li class="list-group-item"><strong>${svg.countAllIndividuals(false)}</strong> Total Individuals</li>
                <li class="list-group-item"><strong>${svg.countAllSpecies(false)}</strong> total species</li>
                <li class="list-group-item"><strong>${svg.countAllIndividuals(true)}</strong> current individuals</li>
                <li class="list-group-item"><strong>${svg.countAllSpecies(true)}</strong> current species</li>
                <li class="list-group-item"><strong>${formatDate(svg.lastUpdate())}</strong> last update</li>`);

        listSunlight.find("li").remove();
        listSunlight.append(`<li class="list-group-item"><strong>${formatTime(sunlight.sunrise)}</strong> sunrise</li>
                <li class="list-group-item"><strong>${formatTime(sunlight.solarNoon)}</strong> solar noon</li>
                <li class="list-group-item"><strong>${formatTime(sunlight.sunset)}</strong> <a href="img/twilight.png">sunset</a></li>
                <li class="list-group-item"><strong>${formatTime(sunlight.dusk)}</strong> <a href="img/twilight.png">civil dusk</a></li>
                <li class="list-group-item"><strong>${formatTime(sunlight.nauticalDusk)}</strong> <a href="img/twilight.png">nautical dusk</a></li>`);

        listSunpos.find("li").remove();
        listSunpos.append(`<li class="list-group-item"><strong>${altitude}&#176;</strong> altitude</li>
                <li class="list-group-item"><strong>${azimuth}&#176; ${GardenAngle.toDirection(azimuth)}</strong> azimuth</li>`);
    }

    function initMenu() {
        html = "";
        GardenConfig.svgs.forEach(s => {
            html += `<a class="dropdown-item" data-svg="${s.id}" href="#">${s.label}</a>`;
        });
        svgMenu.append(html);
    }

    function updateTitle() {
        title.html(`${GardenConfig.findLabel(svgName)}`);
    }

    function updateLinks() {
        gardenLinks.each((i, g) => {
            const target = $(g).attr('data-target');
            $(g).attr('href', `${target}#svg=${svgName}`)
        });
    }

    initMenu();
    updateTitle();
    updateLinks();

    svg.load(() => {
        updateContent();

        GardenWeather.load(svg.latitude, svg.longitude).done(function (res) {
            const obs = res.current_observation;
            const date = formatTime(new Date(obs.observation_epoch * 1000));
            const html = `<img src="${obs.icon_url}">
                <span>${obs.temp_f}&#176; ${obs.weather}</span>
                <ul class="list-group">
                <li class="list-group-item"><strong>${date}</strong> observation</li>
                <li class="list-group-item"><strong>${obs.wind_degrees}&#176; ${GardenAngle.toDirection(obs.wind_degrees)}</strong> wind</li>
                <li class="list-group-item"><strong>${obs.wind_mph}</strong> mph wind</li>
                <li class="list-group-item"><strong>${obs.wind_gust_mph}</strong> mph gust</li>
                </ul>`;

            divWeather.append(html);
        });
    });

    $('a.dropdown-item').click(function (e) {
        svgName = $(this).attr('data-svg');
        svg = new Svg(`img/${svgName}.svg`);

        e.preventDefault();
        history.pushState({}, "Garden", `#svg=${svgName}`);

        updateTitle();
        updateLinks();

        svg.load(() => {
            updateContent();
        });
    });
</script>
</body>
</html>